import json
import datetime

DATA_FILE = "msms.json.txt"
app_data = {}
#core json load and save data functions section
def load_data(path=DATA_FILE):
    global app_data
    try:
        with open (path, "r") as f:
            app_data = json.load(f)
            print ("The data has been retrieved successfully")
    except FileNotFoundError:
        print ("Data file does not exist, initialize with default structure")
        app_data = {
            "students": [],
            "teachers": [],
            "attendance": [],
            "next_student_id": 1,
            "next_teacher_id": 1
        }
def save_data(path = DATA_FILE):
    with open (path, "r") as f:
        json.dump(app_data, f, indent = 4)
    print ("The data has been saved successfully")

#CRUD for both teachers and students
def add_teacher(name, speciality):
    """Adds a teacher dictionary to the data store."""
    teacher_id = app_data["next_teacher_id"]
    new_teacher = {"id": teacher_id, "name": name, "speciality": speciality}
    app_data['teachers'].append(new_teacher)
    app_data['next_teacher_id'] += 1
    print(f"Core: Teacher '{name}' added.")
def update_teacher(teacher_id, **fields):
    """Finds a teacher by ID and updates their data with provided fields."""
    for teacher in app_data['teachers']:
        if teacher['id'] == teacher_id:
            teacher.update(fields)
            print(f"Teacher {teacher_id} updated.")
        else:
            print(f"Error: Teacher with ID {teacher_id} not found.")
def remove_teacher(teacher_id):
    if teacher['id'] == teacher_id:
        app_data['teachers'].remove(app_data['teachers'][teacher_id - 1])
    else:
        print ("This teacher does not exist in the reccords")
def add_student(name):
    """Adds a student dictionary to the data store."""
    student_id = app_data["next_student_id"]
    new_student = {"id": student_id, "name": name, "attendance" : []}
    app_data['students'].append(new_student)
    app_data['next_student_id'] += 1
    print(f"Core: Student '{name}' added.")
def update_student(student_id, **fields):
    """Finds a student by ID and updates their data with provided fields."""
    for student in app_data['student']:
        if student['id'] == student_id:
            student.update(fields)
            print(f"Student {student_id} updated.")
        else:
            print(f"Error: Student with ID {student_id} not found.")
def remove_student(student_id):
    if student['id'] == student_id:
        app_data['students'].remove(app_data['students'][students_id - 1])
    else:
        print ("This student does not exist in the reccords")

#ID Card printing & Receptionist features
def check_in(student_id, course_id, timestamp=None):
    """Records a student's attendance for a course."""
    if timestamp is None:
        timestamp = datetime.datetime.now().isoformat()
    check_in_record = {
        "student_id": student_id,
        "course_id": course_id,
        "timestamp": timestamp
    }
    app_data['attendance'].append(check_in_record)
    print(f"Receptionist: Student {student_id} checked into {course_id}.")

def print_student_card(student_id):
    """Creates a text file badge for a student."""
    student_to_print = None
    for s in app_data['students']:
        if s['id'] == student_id:
            student_to_print = s
            break
    
    if student_to_print != None:
        filename = f"{student_id}_card.txt"
        with open(filename, 'w') as f:
            f.write("========================\n")
            f.write(f"  MUSIC SCHOOL ID BADGE\n")
            f.write("========================\n")
            f.write(f"ID: {student_to_print['id']}\n")
            f.write(f"Name: {student_to_print['name']}\n")
            f.write(f"Enrolled In: {', '.join(student_to_print.get('enrolled_in', []))}\n")
        print(f"Printed student card to {filename}.")
    else:
        print(f"Error: Could not print card, student {student_id} not found.")

def front_desk_register(name, instrument):
    """High-level function to register a new student and enrol them."""
    global next_student_id
    # TODO: Create a new Student object, add it to student_db, and increment the ID.
    new_student = Student(next_student_id, name)
    student_db.append(new_student)
    next_student_id += 1
    
    # TODO: Immediately call front_desk_enrol() using the new student's ID and the provided instrument.
    front_desk_enrol(new_student.id, instrument)
    print(f"Front Desk: Successfully registered '{name}' and enrolled them in '{instrument}'.")

def front_desk_enrol(student_id, instrument):
    """High-level function to enrol an existing student in a course."""
    # TODO: Use your new find_student_by_id() helper.
    student = find_student_by_id(student_id)
    # TODO: If the student is found, append the instrument to their 'enrolled_in' list.
    if student:
        student.enrolled_in.append(instrument)
        print(f"Front Desk: Enrolled student {student_id} in '{instrument}'.")
    else:
        # TODO: If the student is not found, print an error message like "Error: Student ID not found."
        print(f"Error: Student ID {student_id} not found.")

def find_students(term):
    """Finds students by name."""
    print(f"\n--- Finding Students matching '{term}' ---")
    for student in student_db:
        if student.name == term:
            return print(f"  ID: {student.id}, Name: {student.name}, Enrolled in: {student.enrolled_in}")
        else:
            return print ("Student not found")
    # TODO: Create an empty list to store results.
    # Loop through student_db. If the search 'term' (case-insensitive) is in the student's name,
    # add them to your results list.
    # After the loop, if the results list is empty, print "No match found."
    # Otherwise, print the details for each student in the results list.
    pass
def find_teachers(term):
    """Finds teachers by name or speciality."""
    # TODO: Implement this function similar to find_students, but check
    # for the term in BOTH the teacher's name AND their speciality.
    print(f"\n--- Finding Teachers matching '{term}' ---")
    for teacher in teacher_db:
        if teacher.name == term or teacher.speciality == term:
            return print(f"  ID: {teacher.id}, Name: {teacher.name}, Speciality: {teacher.speciality}")
        else:
            return print ("Teacher not found")
    pass
# --- Front Desk Functions ---
def find_student_by_id(student_id):
    """A new helper to find one student by their exact ID."""
    # TODO: Loop through student_db. If a student's ID matches student_id, return the student object.
    for student in student_db:
        if student.id == student_id:
            return student
    # TODO: If the loop finishes without finding a match, return None.
    return None

def front_desk_lookup(term):
    """High-level function to search everything."""
    print(f"\n--- Performing lookup for '{term}' ---")
    find_students(term)
    find_teachers(term)

# Main function, for real this time
def main():
    """Main function to run the MSMS application."""
    load_data() # Load all data from file at startup.

    while True:
        print("\n===== MSMS v2 (Persistent) =====")
        print("1. Check-in Student")
        print("2. Print Student Card")
        print("3. Update Teacher Info")
        print("4. Remove Student")
        print("5. Lookup")
        print("6. Enroll")
        print("q. Quit and Save")
        
        choice = input("Enter your choice: ")
        
        made_change = False # A flag to track if we need to save
        if choice == '1':
            sid = str(input("Please enter your student id: "))
            cid = str(input("Please enter your course id: "))
            check_in(sid,cid)
            made_change = True
        elif choice == '2':
            sid = str(input("Please enter your student id: "))
            print_student_card(sid)
            print ("Your student ID card is ready to be used.")
            pass 
        elif choice == '3':
            tid = str(input("Please enter your teacher id: "))
            news = str(input("Please enter the details you want to updapte: "))
            update_teacher(tid, news)
            made_change = True
        elif choice == '4':
            sid = str(input("Please enter your student id: "))
            remove_student(sid)
            made_change = True
        elif choice == '5':
            # TODO: Prompt for a search term, then call front_desk_lookup.
            term = input("Enter search term: ")
            front_desk_lookup(term)
        elif choice == '6':
            # TODO: Prompt for student ID (as an int) and instrument, then call front_desk_enrol.
            try:
                student_id = int(input("Enter student ID: "))
                instrument = input("Enter instrument to enrol in: ")
                front_desk_enrol(student_id, instrument)
            except ValueError:
                print("Invalid ID. Please enter a number.")
        elif choice.lower() == 'q':
            print("Saving final changes and exiting.")
            break
        else:
            print("Invalid choice.")
            
        if made_change == True:
            save_data() # Save the data immediately after any change.

    save_data() # One final save on exit.

# --- Program Start ---
if __name__ == "__main__":
    main()